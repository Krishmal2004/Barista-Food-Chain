<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Location | Branch Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Custom Dashboard CSS -->
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        #locationMap {
            height: 500px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #locationPickerMap {
            height: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .coordinate-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-family: monospace;
            border: 1px solid #dee2e6;
        }

        .location-status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="bi bi-shop-window text-gold fs-2"></i>
                <h4 class="mb-0 fw-bold">Branch Portal</h4>
            </div>

            <nav class="sidebar-nav">
                <a href="branch-dashboard.html" class="nav-item">
                    <i class="bi bi-speedometer2"></i>
                    <span>Dashboard</span>
                </a>
                <a href="branch-profile.html" class="nav-item">
                    <i class="bi bi-person-circle"></i>
                    <span>Branch Profile</span>
                </a>
                <a href="branch-location.html" class="nav-item active">
                    <i class="bi bi-geo-alt"></i>
                    <span>Location</span>
                </a>
                <a href="branch-concerns.html" class="nav-item">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span>Concerns</span>
                </a>
                <a href="branch-todo.html" class="nav-item">
                    <i class="bi bi-check2-square"></i>
                    <span>Todo List</span>
                </a>
                <div class="nav-divider"></div>
                <a href="#" class="nav-item">
                    <i class="bi bi-gear"></i>
                    <span>Settings</span>
                </a>
                <a href="../branch-login.html" class="nav-item" onclick="return confirmLogout()">
                    <i class="bi bi-box-arrow-left"></i>
                    <span>Logout</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <img src="https://i.pravatar.cc/150?img=33" alt="Manager" class="profile-img">
                    <div class="user-info">
                        <div class="user-name" id="sidebarManagerName">Branch Manager</div>
                        <div class="user-role" id="sidebarBranchName">Loading...</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Navigation Bar -->
            <nav class="topbar">
                <button class="btn btn-link sidebar-toggle" id="sidebarToggle">
                    <i class="bi bi-list fs-4"></i>
                </button>
                <h5 class="mb-0 fw-bold">Manage Location</h5>
                <div class="topbar-actions">
                    <span class="badge bg-light text-dark border" id="locationStatusBadge">
                        <i class="bi bi-geo-alt"></i> Checking location...
                    </span>
                </div>
            </nav>

            <!-- Content Area -->
            <div class="content-area">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="location-status-card">
                            <h5 class="mb-4 fw-bold">Current Branch Location</h5>
                            <div id="locationMap"></div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="mb-1 text-muted">Latitude: <span id="displayLat"
                                            class="fw-bold text-dark">-</span></p>
                                    <p class="mb-0 text-muted">Longitude: <span id="displayLng"
                                            class="fw-bold text-dark">-</span></p>
                                </div>
                                <button class="btn btn-primary" onclick="openSetLocationModal()">
                                    <i class="bi bi-pencil-square"></i> Update Location
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="location-status-card">
                            <h5 class="mb-3 fw-bold">Location Details</h5>
                            <div class="mb-3">
                                <label class="text-muted small">Branch Name</label>
                                <p class="fw-bold mb-0" id="detailBranchName">Loading...</p>
                            </div>
                            <div class="mb-3">
                                <label class="text-muted small">Address</label>
                                <p class="fw-bold mb-0" id="detailAddress">Loading...</p>
                            </div>
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle-fill me-2"></i>
                                Setting your location accurately helps customers find your branch on the main map.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Set Location Modal -->
    <div class="modal fade" id="setLocationModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pin-map-fill me-2"></i>Update Branch Location
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Click on the map</strong> to set the location, or enter coordinates manually.
                    </div>

                    <!-- Map for picking location -->
                    <div id="locationPickerMap"></div>

                    <!-- Coordinate Display -->
                    <div class="coordinate-display">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Latitude</label>
                                <input type="number" class="form-control" id="editLatitude" step="0.000001"
                                    placeholder="e.g., 6.9271" onchange="updateMarkerPosition()">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Longitude</label>
                                <input type="number" class="form-control" id="editLongitude" step="0.000001"
                                    placeholder="e.g., 79.8612" onchange="updateMarkerPosition()">
                            </div>
                        </div>
                    </div>

                    <!-- Quick Location Buttons -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Quick Select City:</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="setQuickLocation(6.9271, 79.8612)">Colombo</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="setQuickLocation(7.2906, 80.6337)">Kandy</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="setQuickLocation(6.0535, 80.2210)">Galle</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="setQuickLocation(9.6615, 80.0255)">Jaffna</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="setQuickLocation(7.2008, 79.8358)">Negombo</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLocation()">
                        <i class="bi bi-check-circle"></i> Save Location
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
        let setLocationModal;
        let pickerMap;
        let displayMap;
        let currentMarker;
        let displayMarker;

        document.addEventListener('DOMContentLoaded', async function () {
            setLocationModal = new bootstrap.Modal(document.getElementById('setLocationModal'));
            await loadBranchDetails();
        });

        async function loadBranchDetails() {
            const branchId = localStorage.getItem('active_branch_id') || 'BCH-001';

            try {
                const response = await fetch(`/api/branch/${branchId}`);
                if (!response.ok) throw new Error('Failed to fetch branch details');

                const result = await response.json();
                const branch = result.data;

                // Update Sidebar and Details
                document.getElementById('sidebarBranchName').textContent = branch.branch_name || 'Unknown';
                document.getElementById('sidebarManagerName').textContent = branch.contact_full_name || 'Manager';
                document.getElementById('detailBranchName').textContent = branch.branch_name || 'N/A';
                document.getElementById('detailAddress').textContent = branch.address || 'N/A';

                // Setup Maps
                const lat = branch.latitude;
                const lng = branch.longitude;

                if (lat && lng) {
                    initDisplayMap(lat, lng);
                    document.getElementById('displayLat').textContent = lat.toFixed(6);
                    document.getElementById('displayLng').textContent = lng.toFixed(6);

                    const statusBadge = document.getElementById('locationStatusBadge');
                    statusBadge.className = 'badge bg-success-subtle text-success border border-success';
                    statusBadge.innerHTML = '<i class="bi bi-check-circle-fill"></i> Location Set';
                } else {
                    initDisplayMap(6.9271, 79.8612); // Default to Colombo
                    document.getElementById('displayLat').textContent = 'Not Set';
                    document.getElementById('displayLng').textContent = 'Not Set';

                    const statusBadge = document.getElementById('locationStatusBadge');
                    statusBadge.className = 'badge bg-warning-subtle text-warning border border-warning';
                    statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Location Missing';
                }

            } catch (error) {
                console.error('Error loading branch details:', error);
                alert('Error loading branch details. Please refresh.');
            }
        }

        function initDisplayMap(lat, lng) {
            if (displayMap) displayMap.remove();

            displayMap = L.map('locationMap').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(displayMap);

            displayMarker = L.marker([lat, lng]).addTo(displayMap)
                .bindPopup('Branch Location')
                .openPopup();
        }

        function openSetLocationModal() {
            // Get current values or default
            let lat = parseFloat(document.getElementById('displayLat').textContent);
            let lng = parseFloat(document.getElementById('displayLng').textContent);

            if (isNaN(lat)) lat = 6.9271;
            if (isNaN(lng)) lng = 79.8612;

            document.getElementById('editLatitude').value = lat;
            document.getElementById('editLongitude').value = lng;

            setLocationModal.show();

            // Initialize picker map after modal shows
            setTimeout(() => {
                initPickerMap(lat, lng);
            }, 300);
        }

        function initPickerMap(lat, lng) {
            if (pickerMap) pickerMap.remove();

            pickerMap = L.map('locationPickerMap').setView([lat, lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(pickerMap);

            currentMarker = L.marker([lat, lng], { draggable: true }).addTo(pickerMap);

            currentMarker.on('dragend', function (e) {
                const pos = e.target.getLatLng();
                document.getElementById('editLatitude').value = pos.lat.toFixed(6);
                document.getElementById('editLongitude').value = pos.lng.toFixed(6);
            });

            pickerMap.on('click', function (e) {
                currentMarker.setLatLng(e.latlng);
                document.getElementById('editLatitude').value = e.latlng.lat.toFixed(6);
                document.getElementById('editLongitude').value = e.latlng.lng.toFixed(6);
            });
        }

        function updateMarkerPosition() {
            const lat = parseFloat(document.getElementById('editLatitude').value);
            const lng = parseFloat(document.getElementById('editLongitude').value);

            if (lat && lng && currentMarker) {
                currentMarker.setLatLng([lat, lng]);
                pickerMap.setView([lat, lng], 13);
            }
        }

        function setQuickLocation(lat, lng) {
            document.getElementById('editLatitude').value = lat;
            document.getElementById('editLongitude').value = lng;
            updateMarkerPosition();
        }

        async function saveLocation() {
            const branchId = localStorage.getItem('active_branch_id') || 'BCH-001';
            const lat = parseFloat(document.getElementById('editLatitude').value);
            const lng = parseFloat(document.getElementById('editLongitude').value);

            if (!lat || !lng) {
                alert('Please provide valid coordinates');
                return;
            }

            try {
                // Assuming same endpoint as location.html uses
                const response = await fetch(`/api/branches/location/${branchId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ latitude: lat, longitude: lng })
                });

                if (response.ok) {
                    alert('Location updated successfully!');
                    setLocationModal.hide();
                    await loadBranchDetails(); // Reload to update main map
                } else {
                    const err = await response.json();
                    alert('Failed to update: ' + (err.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving location:', error);
                alert('Network error during save.');
            }
        }

        function confirmLogout() {
            return confirm('Are you sure you want to logout?');
        }
    </script>
</body>

</html>